@TARGET_DEFECATION_CHECK
#DIM DYNAMIC INCREASE_OF_DEFECATE
#DIM DYNAMIC INCREASE_OF_FACES
#DIM DYNAMIC STRENGTH
#DIM DYNAMIC LCOUNT

SIF MAXBASE:便意 <= 0
	RETURN

INCREASE_OF_DEFECATE = 100

SELECTCASE SELECTCOMS
	CASE "お酒を飲ませる", "ジュースを飲ませる"
		INCREASE_OF_DEFECATE = 110
	CASE "アナル舐め", "アナル愛撫"
		INCREASE_OF_DEFECATE = 120
	CASE "アナルバイブ", "アナルビーズ"
		INCREASE_OF_DEFECATE = 150
	CASE "腹パン", "アナルフィスト"
		INCREASE_OF_DEFECATE = 200
	CASE "臍フィスト", "両穴フィスト"
		INCREASE_OF_DEFECATE = 250
ENDSELECT

INCREASE_OF_DEFECATE += (EXP:排便経験 / 10) + (EXP:Ａ拡張経験 / 5) + (EXP:Ａ経験 / 10)

FOR LCOUNT, 0, VARSIZE("TALENT")
	SIF !TALENT:LCOUNT
		CONTINUE

	SELECTCASE TALENTNAME:LCOUNT
		CASE "潔癖症"
			TIMES INCREASE_OF_DEFECATE, 0.7
		CASE "濡れにくい"
			TIMES INCREASE_OF_DEFECATE, 0.8
		CASE "プライド高い", "恥じらい"
			TIMES INCREASE_OF_DEFECATE, 0.9
		CASE "プライド低い", "楽観的", "恥薄い"
			TIMES INCREASE_OF_DEFECATE, 1.1
		CASE "濡れやすい", "おもらし癖"
			TIMES INCREASE_OF_DEFECATE, 1.2
	ENDSELECT
NEXT

SELECTCASE MARK:屈服刻印
	CASE 1
		TIMES INCREASE_OF_DEFECATE, 1.1
	CASE 2
		TIMES INCREASE_OF_DEFECATE, 1.2
	CASE 3
		TIMES INCREASE_OF_DEFECATE, 1.5
ENDSELECT

SELECTCASE MARK:反発刻印
	CASE 1
		TIMES INCREASE_OF_DEFECATE, 0.9
	CASE 2
		TIMES INCREASE_OF_DEFECATE, 0.8
	CASE 3
		TIMES INCREASE_OF_DEFECATE, 0.5
ENDSELECT

SIF BASE:便量 / (MAXBASE:便量 / 100) < 33
	TIMES INCREASE_OF_DEFECATE, 0.5

BASE:便意 += INCREASE_OF_DEFECATE

INCREASE_OF_FACES = 5
SELECTCASE SELECTCOMS
	CASE "お菓子を作る"
		INCREASE_OF_DEFECATE = 8
ENDSELECT

FOR LCOUNT, 0, VARSIZE("TALENT")
	SIF !TALENT:LCOUNT
		CONTINUE

	SELECTCASE TALENTNAME:LCOUNT
		CASE "アニマル", "ファーリー"
			TIMES INCREASE_OF_FACES, 1.5
		CASE "体格"
			SELECTCASE TALENT:LCOUNT
				CASE 1
					TIMES INCREASE_OF_FACES, 0.8
				CASE 2
					TIMES INCREASE_OF_FACES, 0.9
				CASE 4
					TIMES INCREASE_OF_FACES, 1.1
			ENDSELECT
	ENDSELECT
NEXT

FOR LCOUNT, 0, VARSIZE("TALENT")
	SIF !TALENT:PLAYER:LCOUNT
		CONTINUE

	SELECTCASE TALENTNAME:LCOUNT
		CASE "魔法使い", "禁断の知識"
			TIMES INCREASE_OF_FACES, 2
	ENDSELECT
NEXT

BASE:便量 += INCREASE_OF_FACES

; TODO: Calculate source

STRENGTH = BASE:便意/MAXBASE:便意

IF STRENGTH > 0 && !A使用中(TARGET) || STRENGTH >= 2 || BASE:便量/MAXBASE:便量 >= 2
	SETBIT STAIN:アナル, 8
	NOWEX:排便 = STRENGTH
	EX:排便++
	CALL EXPUP, "排便経験", LIMIT(BASE:便量/100, 1, 10)
	CALL EXPUP, "Ａ経験", LIMIT(BASE:便量/100, 1, 10)
	SIF BASE:便量/MAXBASE:便量 >= 2
		CALL EXPUP, "Ａ拡張経験", 1

	BASE:便意 = 0
	BASE:便量 = 0
	CALL Ａ道具解除, TARGET
ENDIF
