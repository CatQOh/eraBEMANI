@PRECIPITATION
#DIM DYNAMIC F1
	;1ミリ以上になる日数
#DIM DYNAMIC F10
	;10ミリ以上になる日数
#DIM DYNAMIC P_A
	;関数F(X)のパラメータA
#DIM DYNAMIC P_B
	;関数F(X)のパラメータB
#DIM DYNAMIC R_MM, 51
	;R_MM:Xで雨量Xミリ以上になる確率(パーセント)

;降水量を算出する関数

;次のような流れで導き出す
;降水量Xミリ以上になる確率(パーセント)を算出する関数F(X)をパラメータA,Bを用いて、
;F(X) = 100 / (1 + B*X^A) とおく
;この関数は必ず定点(0,100)を通る(降水量0ミリ以上になる確率は100パーセント)
;また、F(X)→0 (X→∞) である
;この関数をおいたあと、気象庁から東京の1981年～2010年の1日ごとの
;1ミリ以上になる日数(X=1のときのF(1)の値)と10ミリ以上になる日数(X=10のときのF(10)の値)を取得する
;例えば1月1日は1ミリ以上になる日数が0.12日なので、12パーセントの確率で1ミリ以上になると考える
;平面座標(X,F(X))における2点を定めると関数F(X)は一意に定まる(パラメータA,Bの値が確定する)
;次の連立方程式でA,Bの値を求める
;	F(1)  = 100 / (1 + B)      …①
;	F(10) = 100 / (1 + B*10^A) …②
;①よりBの値を求める

;F(1)*(1+B) = 100
;1+B = 100/F(1)
;B = 100/F(1) - 1

;この値を②に代入して、

;(1 + B*10^A) * F(10) = 100
;(1 + B*10^A) = F(10) / 100
;	B*10^A =  100/F(10) - 1
;	  10^A = (100/F(10) - 1) / B
;	     A = LOG10( (100/F(10) - 1) / B )
;関数が確定したあと、Xミリ以上になる確率を1ミリごとに計算
;あとはRAND:100で雨量を算出

;雨量のサンプルを取得して代入
CALL TOKYO_STYLE_RAINY_DAY
F1 = RESULT
F10 = RESULT:1

;はじめにBの値を求める
P_B = 100/F1 - 1

;Bの値を用いてAの値を求める
;ただし、整数しか使えない都合でAの値は10乗して使う
;10*LOG10(X) = LOG10(X^10) を利用
P_A = LOG10(POWER( (100/F10 -1 )/P_B, 10 ))

;パラメータA,B(変数P_A,P_B)が求まったので具体的に計算
;F(X) = 100000 / (1000+1000*B*X^A)
;分母・分子をそれぞれ1000倍して計算
;また、X^A = EXP(A*LOG(X)) （LOGは自然対数）と、
;EXP(X) = 1 + X + X^2/2! + X^3/3! + … + X^N/N! +… （指数関数のテイラー展開）を用いる
FOR COUNT, 1, 51
	;1000*B*X^A = 1000*B*EXP(A*LOG(X)) より、
	;A*LOG(X)の1000倍の値を求めてそれをLOCALとする
	;HLOG(X)はXの自然対数の100倍
	;P_Aが本来の10倍でとってあるのでLOCALは本来の1000倍
	LOCAL = P_A * HLOG(COUNT)
	
	;次に 1000*B*EXP(LOCAL/1000) を計算しそれをLOCAL:1に代入
	;テイラー展開の4乗の項まで計算
	;LOCAL=3000でも耐えられる
	LOCAL:1 = 1000 * P_B
	LOCAL:1 += 1000 * P_B * LOCAL / 1000
	LOCAL:1 += 1000 * P_B * POWER(LOCAL,2) / POWER(1000,2) / 2
	LOCAL:1 += 1000 * P_B * POWER(LOCAL,3) / POWER(1000,3) / 6
	LOCAL:1 += 1000 * P_B * POWER(LOCAL,4) / POWER(1000,4) / 24
	
	;最後に F(X) = 100000 / (1000+LOCAL:1) を求めてR_MM:Xに代入
	R_MM:COUNT = 100000 / (1000+LOCAL:1)
NEXT

;R_MM:1～R_MM:50の値が揃ったのであとはその分布に従い雨量を出す
SELECTCASE RAND:100
	CASE IS > R_MM:1
		FLAG:降水量 = 0
	CASE IS > R_MM:2
		FLAG:降水量 = 1
	CASE IS > R_MM:3
		FLAG:降水量 = 2
	CASE IS > R_MM:4
		FLAG:降水量 = 3
	CASE IS > R_MM:5
		FLAG:降水量 = 4
	CASE IS > R_MM:6
		FLAG:降水量 = 5
	CASE IS > R_MM:7
		FLAG:降水量 = 6
	CASE IS > R_MM:8
		FLAG:降水量 = 7
	CASE IS > R_MM:9
		FLAG:降水量 = 8
	CASE IS > R_MM:10
		FLAG:降水量 = 9
	CASE IS > R_MM:11
		FLAG:降水量 = 10
	CASE IS > R_MM:12
		FLAG:降水量 = 11
	CASE IS > R_MM:13
		FLAG:降水量 = 12
	CASE IS > R_MM:14
		FLAG:降水量 = 13
	CASE IS > R_MM:15
		FLAG:降水量 = 14
	CASE IS > R_MM:16
		FLAG:降水量 = 15
	CASE IS > R_MM:17
		FLAG:降水量 = 16
	CASE IS > R_MM:18
		FLAG:降水量 = 17
	CASE IS > R_MM:19
		FLAG:降水量 = 18
	CASE IS > R_MM:20
		FLAG:降水量 = 19
	CASE IS > R_MM:21
		FLAG:降水量 = 20
	CASE IS > R_MM:22
		FLAG:降水量 = 21
	CASE IS > R_MM:23
		FLAG:降水量 = 22
	CASE IS > R_MM:24
		FLAG:降水量 = 23
	CASE IS > R_MM:25
		FLAG:降水量 = 24
	CASE IS > R_MM:26
		FLAG:降水量 = 25
	CASE IS > R_MM:27
		FLAG:降水量 = 26
	CASE IS > R_MM:28
		FLAG:降水量 = 27
	CASE IS > R_MM:29
		FLAG:降水量 = 28
	CASE IS > R_MM:30
		FLAG:降水量 = 29
	CASE IS > R_MM:31
		FLAG:降水量 = 30
	CASE IS > R_MM:32
		FLAG:降水量 = 31
	CASE IS > R_MM:33
		FLAG:降水量 = 32
	CASE IS > R_MM:34
		FLAG:降水量 = 33
	CASE IS > R_MM:35
		FLAG:降水量 = 34
	CASE IS > R_MM:36
		FLAG:降水量 = 35
	CASE IS > R_MM:37
		FLAG:降水量 = 36
	CASE IS > R_MM:38
		FLAG:降水量 = 37
	CASE IS > R_MM:39
		FLAG:降水量 = 38
	CASE IS > R_MM:40
		FLAG:降水量 = 39
	CASE IS > R_MM:41
		FLAG:降水量 = 40
	CASE IS > R_MM:42
		FLAG:降水量 = 41
	CASE IS > R_MM:43
		FLAG:降水量 = 42
	CASE IS > R_MM:44
		FLAG:降水量 = 43
	CASE IS > R_MM:45
		FLAG:降水量 = 44
	CASE IS > R_MM:46
		FLAG:降水量 = 45
	CASE IS > R_MM:47
		FLAG:降水量 = 46
	CASE IS > R_MM:48
		FLAG:降水量 = 47
	CASE IS > R_MM:49
		FLAG:降水量 = 48
	CASE IS > R_MM:50
		FLAG:降水量 = 49
	CASEELSE
		FLAG:降水量 = 50
ENDSELECT


@TOKYO_STYLE_RAINY_DAY
;気象庁から東京の1981年～2010年の1日ごとの、1ミリ以上になる日数と10ミリ以上になる日数を取得する関数
;1日に対するパーセンテージで取得するため0.12日は12として扱う

;1ミリ以上になる日数の計算
SELECTCASE MONTH
	CASE 1
		SELECTCASE DAYS
			CASE 1, 2
				LOCAL = 12
			CASE 3, 4
				LOCAL = 13
			CASE 5 TO 7
				LOCAL = 14
			CASE 8 TO 15
				LOCAL = 15
			CASE 16 TO 19
				LOCAL = 16
			CASE 20, 21
				LOCAL = 17
			CASE 22 TO 25
				LOCAL = 16
			CASE 26 TO 28
				LOCAL = 15
			CASE 29 TO 31
				LOCAL = 14
		ENDSELECT
	CASE 2
		SELECTCASE DAYS
			CASE 1, 2
				LOCAL = 14
			CASE 3 TO 5
				LOCAL = 15
			CASE 6 TO 8
				LOCAL = 16
			CASE 9, 10
				LOCAL = 17
			CASE 11, 12
				LOCAL = 18
			CASE 13, 14
				LOCAL = 19
			CASE 15, 16
				LOCAL = 20
			CASE 17, 18
				LOCAL = 21
			CASE 19
				LOCAL = 22
			CASE 20, 21
				LOCAL = 23
			CASE 22, 23
				LOCAL = 24
			CASE 24, 25
				LOCAL = 25
			CASE 26 TO 29
				LOCAL = 26
		ENDSELECT
	CASE 3
		SELECTCASE DAYS
			CASE 1
				LOCAL = 26
			CASE 2 TO 9
				LOCAL = 27
			CASE 10, 11
				LOCAL = 28
			CASE 12, 13
				LOCAL = 29
			CASE 14
				LOCAL = 30
			CASE 15
				LOCAL = 31
			CASE 16, 17
				LOCAL = 32
			CASE 18
				LOCAL = 33
			CASE 19, 20
				LOCAL = 34
			CASE 21 TO 27
				LOCAL = 35
			CASE 28 TO 30
				LOCAL = 34
			CASE 31
				LOCAL = 33
		ENDSELECT
	CASE 4
		SELECTCASE DAYS
			CASE 1 TO 6
				LOCAL = 33
			CASE 7 TO 9
				LOCAL = 34
			CASE 10 TO 18
				LOCAL = 35
			CASE 19 TO 21
				LOCAL = 34
			CASE 22 TO 24
				LOCAL = 33
			CASE 25, 26
				LOCAL = 32
			CASE 27, 28
				LOCAL = 31
			CASE 29, 30
				LOCAL = 30
		ENDSELECT
	CASE 5
		SELECTCASE DAYS
			CASE 1 TO 6
				LOCAL = 30
			CASE 7, 8
				LOCAL = 31
			CASE 9
				LOCAL = 32
			CASE 10
				LOCAL = 33
			CASE 11, 12
				LOCAL = 34
			CASE 13 TO 22
				LOCAL = 35
			CASE 23 TO 25
				LOCAL = 34
			CASE 26, 27
				LOCAL = 33
			CASE 28
				LOCAL = 32
			CASE 29
				LOCAL = 31
			CASE 30, 31
				LOCAL = 30
		ENDSELECT
	CASE 6
		SELECTCASE DAYS
			CASE 1 TO 4
				LOCAL = 29
			CASE 5
				LOCAL = 30
			CASE 6
				LOCAL = 31
			CASE 7
				LOCAL = 32
			CASE 8
				LOCAL = 33
			CASE 9
				LOCAL = 34
			CASE 10
				LOCAL = 35
			CASE 11
				LOCAL = 36
			CASE 12
				LOCAL = 37
			CASE 13
				LOCAL = 38
			CASE 14, 15
				LOCAL = 39
			CASE 16
				LOCAL = 40
			CASE 17, 18
				LOCAL = 41
			CASE 19
				LOCAL = 42
			CASE 20, 21
				LOCAL = 43
			CASE 22, 23
				LOCAL = 44
			CASE 24 TO 28
				LOCAL = 45
			CASE 29, 30
				LOCAL = 44
		ENDSELECT
	CASE 7
		SELECTCASE DAYS
			CASE 1
				LOCAL = 43
			CASE 2
				LOCAL = 42
			CASE 3
				LOCAL = 41
			CASE 4
				LOCAL = 40
			CASE 5
				LOCAL = 39
			CASE 6
				LOCAL = 38
			CASE 7, 8
				LOCAL = 37
			CASE 9, 10
				LOCAL = 36
			CASE 11 TO 14
				LOCAL = 35
			CASE 15, 16
				LOCAL = 34
			CASE 17, 18
				LOCAL = 33
			CASE 19, 20
				LOCAL = 32
			CASE 21
				LOCAL = 31
			CASE 22, 23
				LOCAL = 30
			CASE 24
				LOCAL = 29
			CASE 25, 26
				LOCAL = 28
			CASE 27
				LOCAL = 27
			CASE 28, 29
				LOCAL = 26
			CASE 30, 31
				LOCAL = 25
		ENDSELECT
	CASE 8
		SELECTCASE DAYS
			CASE 1
				LOCAL = 25
			CASE 2 TO 7
				LOCAL = 24
			CASE 8 TO 10
				LOCAL = 25
			CASE 11 TO 20
				LOCAL = 24
			CASE 21 TO 23
				LOCAL = 25
			CASE 24 TO 27
				LOCAL = 26
			CASE 28 TO 31
				LOCAL = 27
		ENDSELECT
	CASE 9
		SELECTCASE DAYS
			CASE 1, 2
				LOCAL = 28
			CASE 3
				LOCAL = 29
			CASE 4
				LOCAL = 30
			CASE 5
				LOCAL = 31
			CASE 6
				LOCAL = 32
			CASE 7
				LOCAL = 33
			CASE 8
				LOCAL = 34
			CASE 9
				LOCAL = 35
			CASE 10
				LOCAL = 36
			CASE 11
				LOCAL = 37
			CASE 12
				LOCAL = 38
			CASE 13 TO 15
				LOCAL = 39
			CASE 16 TO 19
				LOCAL = 40
			CASE 20, 21
				LOCAL = 41
			CASE 22 TO 27
				LOCAL = 40
			CASE 28 TO 30
				LOCAL = 39
		ENDSELECT
	CASE 10
		SELECTCASE DAYS
			CASE 1 TO 5
				LOCAL = 38
			CASE 6 TO 8
				LOCAL = 37
			CASE 9, 10
				LOCAL = 36
			CASE 11
				LOCAL = 35
			CASE 12
				LOCAL = 34
			CASE 13
				LOCAL = 33
			CASE 14, 15
				LOCAL = 32
			CASE 16, 17
				LOCAL = 31
			CASE 18, 19
				LOCAL = 30
			CASE 20 TO 23
				LOCAL = 29
			CASE 24, 25
				LOCAL = 28
			CASE 26
				LOCAL = 27
			CASE 27, 28
				LOCAL = 26
			CASE 29, 30
				LOCAL = 25
			CASE 31
				LOCAL = 24
		ENDSELECT
	CASE 11
		SELECTCASE DAYS
			CASE 1 TO 6
				LOCAL = 24
			CASE 7 TO 11
				LOCAL = 25
			CASE 12 TO 14
				LOCAL = 24
			CASE 15 TO 17
				LOCAL = 23
			CASE 18, 19
				LOCAL = 22
			CASE 20 TO 23
				LOCAL = 21
			CASE 24 TO 27
				LOCAL = 20
			CASE 28 TO 30
				LOCAL = 19
		ENDSELECT
	CASE 12
		SELECTCASE DAYS
			CASE 1
				LOCAL = 19
			CASE 2 TO 4
				LOCAL = 18
			CASE 5 TO 7
				LOCAL = 17
			CASE 8 TO 10
				LOCAL = 16
			CASE 11 TO 13
				LOCAL = 15
			CASE 14, 15
				LOCAL = 14
			CASE 16 TO 18
				LOCAL = 13
			CASE 19 TO 21
				LOCAL = 12
			CASE 22 TO 30
				LOCAL = 11
			CASE 31
				LOCAL = 12
		ENDSELECT
ENDSELECT
;10ミリ以上になる日数の計算
SELECTCASE MONTH
	CASE 1
		SELECTCASE DAYS
			CASE 1 TO 7
				LOCAL:1 = 5
			CASE 8 TO 15
				LOCAL:1 = 6
			CASE 16 TO 25
				LOCAL:1 = 7
			CASE 26 TO 30
				LOCAL:1 = 6
			CASE 31
				LOCAL:1 = 5
		ENDSELECT
	CASE 2
		SELECTCASE DAYS
			CASE 1 TO 3
				LOCAL:1 = 5
			CASE 4 TO 8
				LOCAL:1 = 4
			CASE 9 TO 11
				LOCAL:1 = 5
			CASE 12
				LOCAL:1 = 6
			CASE 13, 14
				LOCAL:1 = 7
			CASE 15, 16
				LOCAL:1 = 8
			CASE 17, 18
				LOCAL:1 = 9
			CASE 19 TO 29
				LOCAL:1 = 10
		ENDSELECT
	CASE 3
		SELECTCASE DAYS
			CASE 1 TO 7
				LOCAL:1 = 10
			CASE 8 TO 10
				LOCAL:1 = 11
			CASE 11 TO 13
				LOCAL:1 = 12
			CASE 14 TO 16
				LOCAL:1 = 13
			CASE 17 TO 21
				LOCAL:1 = 14
			CASE 22 TO 25
				LOCAL:1 = 15
			CASE 26 TO 31
				LOCAL:1 = 16
		ENDSELECT
	CASE 4
		SELECTCASE DAYS
			CASE 1 TO 5
				LOCAL:1 = 16
			CASE 6 TO 10
				LOCAL:1 = 15
			CASE 11 TO 22
				LOCAL:1 = 14
			CASE 23, 24
				LOCAL:1 = 13
			CASE 25 TO 27
				LOCAL:1 = 12
			CASE 28 TO 30
				LOCAL:1 = 11
		ENDSELECT
	CASE 5
		SELECTCASE DAYS
			CASE 1 TO 3
				LOCAL:1 = 11
			CASE 4, 5
				LOCAL:1 = 12
			CASE 6, 7
				LOCAL:1 = 13
			CASE 8, 9
				LOCAL:1 = 14
			CASE 10, 11
				LOCAL:1 = 15
			CASE 12, 13
				LOCAL:1 = 16
			CASE 14 TO 23
				LOCAL:1 = 17
			CASE 24 TO 28
				LOCAL:1 = 16
			CASE 29 TO 31
				LOCAL:1 = 15
		ENDSELECT
	CASE 6
		SELECTCASE DAYS
			CASE 1 TO 4
				LOCAL:1 = 14
			CASE 5, 6
				LOCAL:1 = 15
			CASE 7, 8
				LOCAL:1 = 16
			CASE 9
				LOCAL:1 = 17
			CASE 10, 11
				LOCAL:1 = 18
			CASE 12, 13
				LOCAL:1 = 19
			CASE 14 TO 29
				LOCAL:1 = 20
			CASE 31
				LOCAL:1 = 19
		ENDSELECT
	CASE 7
		SELECTCASE DAYS
			CASE 1, 2
				LOCAL:1 = 19
			CASE 3, 4
				LOCAL:1 = 18
			CASE 5, 6
				LOCAL:1 = 17
			CASE 7, 8
				LOCAL:1 = 16
			CASE 9
				LOCAL:1 = 15
			CASE 10, 11
				LOCAL:1 = 14
			CASE 12 TO 14
				LOCAL:1 = 13
			CASE 15 TO 30
				LOCAL:1 = 12
			CASE 31
				LOCAL:1 = 11
		ENDSELECT
	CASE 8
		SELECTCASE DAYS
			CASE 1 TO 6
				LOCAL:1 = 11
			CASE 7 TO 18
				LOCAL:1 = 12
			CASE 19 TO 24
				LOCAL:1 = 11
			CASE 25 TO 28
				LOCAL:1 = 12
			CASE 29, 30
				LOCAL:1 = 13
			CASE 31
				LOCAL:1 = 14
		ENDSELECT
	CASE 9
		SELECTCASE DAYS
			CASE 1, 2
				LOCAL:1 = 14
			CASE 3, 4
				LOCAL:1 = 15
			CASE 5
				LOCAL:1 = 16
			CASE 6, 7
				LOCAL:1 = 17
			CASE 8 TO 10
				LOCAL:1 = 18
			CASE 11 TO 23
				LOCAL:1 = 19
			CASE 24 TO 30
				LOCAL:1 = 20
		ENDSELECT
	CASE 10
		SELECTCASE DAYS
			CASE 1 TO 4
				LOCAL:1 = 20
			CASE 5, 6
				LOCAL:1 = 21
			CASE 7 TO 10
				LOCAL:1 = 20
			CASE 11, 12
				LOCAL:1 = 19
			CASE 13
				LOCAL:1 = 18
			CASE 14 TO 15
				LOCAL:1 = 17
			CASE 16 TO 17
				LOCAL:1 = 16
			CASE 18 TO 20
				LOCAL:1 = 15
			CASE 21 TO 23
				LOCAL:1 = 14
			CASE 24, 25
				LOCAL:1 = 13
			CASE 26 TO 28
				LOCAL:1 = 12
			CASE 29 TO 31
				LOCAL:1 = 11
		ENDSELECT
	CASE 11
		SELECTCASE DAYS
			CASE 1 TO 7
				LOCAL:1 = 10
			CASE 8 TO 12
				LOCAL:1 = 9
			CASE 13 TO 30
				LOCAL:1 = 8
		ENDSELECT
	CASE 12
		SELECTCASE DAYS
			CASE 1, 2
				LOCAL:1 = 8
			CASE 2 TO 7
				LOCAL:1 = 7
			CASE 8 TO 11
				LOCAL:1 = 6
			CASE 12 TO 17
				LOCAL:1 = 5
			CASE 18 TO 30
				LOCAL:1 = 4
			CASE 31
				LOCAL:1 = 5
		ENDSELECT
ENDSELECT

RETURN LOCAL, LOCAL:1


@HLOG(ARG)
#FUNCTION
;ARGの自然対数の100倍を返す式中関数
;とりあえず50まで
SELECTCASE ARG
	CASE IS <= 1
		RETURNF 0
	CASE 2
		RETURNF 69
	CASE 3
		RETURNF 110
	CASE 4
		RETURNF 139
	CASE 5
		RETURNF 161
	CASE 6
		RETURNF 179
	CASE 7
		RETURNF 195
	CASE 8
		RETURNF 208
	CASE 9
		RETURNF 220
	CASE 10
		RETURNF 230
	CASE 11
		RETURNF 240
	CASE 12
		RETURNF 248
	CASE 13
		RETURNF 256
	CASE 14
		RETURNF 264
	CASE 15
		RETURNF 271
	CASE 16
		RETURNF 277
	CASE 17
		RETURNF 283
	CASE 18
		RETURNF 289
	CASE 19
		RETURNF 294
	CASE 20
		RETURNF 300
	CASE 21
		RETURNF 304
	CASE 22
		RETURNF 309
	CASE 23
		RETURNF 314
	CASE 24
		RETURNF 318
	CASE 25
		RETURNF 322
	CASE 26
		RETURNF 326
	CASE 27
		RETURNF 330
	CASE 28
		RETURNF 333
	CASE 29
		RETURNF 337
	CASE 30
		RETURNF 340
	CASE 31
		RETURNF 343
	CASE 32
		RETURNF 347
	CASE 33
		RETURNF 350
	CASE 34
		RETURNF 353
	CASE 35
		RETURNF 356
	CASE 36
		RETURNF 358
	CASE 37
		RETURNF 361
	CASE 38
		RETURNF 364
	CASE 39
		RETURNF 366
	CASE 40
		RETURNF 369
	CASE 41
		RETURNF 371
	CASE 42
		RETURNF 374
	CASE 43
		RETURNF 376
	CASE 44
		RETURNF 378
	CASE 45
		RETURNF 381
	CASE 46
		RETURNF 383
	CASE 47
		RETURNF 385
	CASE 48
		RETURNF 387
	CASE 49
		RETURNF 389
	CASEELSE
		RETURNF 391
ENDSELECT
