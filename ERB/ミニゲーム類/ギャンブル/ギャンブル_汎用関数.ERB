@GAMBLE, カジノの種類
#DIM DYNAMIC チップ
#DIM DYNAMIC 利子
#DIM DYNAMIC 利益計算用
#DIM DYNAMIC パートナー
#DIM DYNAMIC LCOUNT
#DIM DYNAMIC パートナー必要
#DIM DYNAMIC カードゲーム
#DIM DYNAMIC 収支
#DIM DYNAMIC カジノの種類 = 1;引数指定が無ければ表カジノ扱い
#DIM DYNAMIC キャラ価格
#DIM DYNAMIC 売却候補, 1000
#DIM DYNAMIC 売却総額
#DIM DYNAMIC LTARGET
#DIM DYNAMIC LASSI
;新しくゲームを追加する場合はここに名称を追加する
{
#DIMS DYNAMIC ゲーム名, 10 = 
"ルーレット",
"クラップス",
"ブラックジャック",
"ビンゴピンボール",
"ビデオポーカー",
"ポーカーソリティア",
"レットイットライド",
"バカラ",
"サーティー",
"素数ダイス",
}
;"神経衰弱",

;ギャンブルで借金を背負った場合の利子(難易度によって変動)
SELECTCASE FLAG:難易度
	;NORMAL
	CASE 1
		利子 = 25
	;HYPER
	CASE 2
		利子 = 55
	;ANOTHER
	CASE 3
		利子 = 90
ENDSELECT

;始めるときの金額を記憶
利益計算用 = MONEY

DRAWLINE
SELECTCASE カジノの種類
	;表カジノ
	CASE 1
		PRINTL カジノへようこそ。どのギャンブルで遊びますか？
		PRINTL ただし、ギャンブル中に借金を背負って返済できなかった場合、
		PRINTFORML その借金に対し、{利子}\%の利子が付きます。(10日に一度、返済を要求されます。その度に利子が発生します)
	;裏カジノ
	CASE 2
		PRINTL 大金と命を賭けたクレイジーなカジノへようこそ！どのギャンブルで遊びますか？
		PRINTL ただし、ギャンブル中に借金を背負って返済できなかった場合、
		FONTBOLD
		PRINT 裏カジノ特有のやり方
		FONTREGULAR
		PRINTL で借金の返済をしていただきます。
ENDSELECT
CALL PASELIL, @"所持金:{MONEY}＄"

FOR LCOUNT, 0, VARSIZE("ゲーム名")
	SELECTCASE ゲーム名:LCOUNT
		;バカラは裏専用
		CASE "バカラ"
			SIF カジノの種類 != 1
				CONTINUE
	ENDSELECT
	PRINTFORMLC [{LCOUNT}] %ゲーム名:LCOUNT%
NEXT
SIF !LINEISEMPTY()
	PRINTL
[IF_DEBUG]
	PRINTL [96] モンテカルロ
	PRINTL [97] ナンプレ
	PRINTL [98] ねらえ！ぴったり７
[ENDIF]
DRAWLINE
PRINTPLAIN 　GAMBLE　
PRINTL [99] やめておく
$SELECT_GAMBLE
DO
	INPUT
	SELECTCASE RESULT
		CASE 0 TO VARSIZE("ゲーム名")
			PRINTFORMW %CALLNAME:MASTER%は%ゲーム名:RESULT%で遊ぶことにした。
			;カードゲームならカードゲームフラグを立てる
			SELECTCASE ゲーム名:RESULT
				CASE "ブラックジャック", "ビデオポーカー", "ポーカーソリティア", "レットイットライド", "バカラ"
					カードゲーム = 1
			ENDSELECT
			;パートナーが必要なゲームならフラグを立てる
			;SELECTCASE ゲーム名:RESULT
			;	CASE
			;		パートナー必要 = 1
			;ENDSELECT
			IF パートナー必要
				TRYCCALLFORM %ゲーム名:RESULT%, パートナー
				CATCH
					PRINTFORMW %ゲーム名:RESULT%は未実装です
					RESTART
				ENDCATCH
			ELSE
				TRYCCALLFORM %ゲーム名:RESULT%, カジノの種類
				CATCH
					PRINTFORMW %ゲーム名:RESULT%は未実装です
					RESTART
				ENDCATCH
			ENDIF
			BREAK
		CASE 96
			[IF_DEBUG]
				CALL モンテカルロ
				BREAK
			[ENDIF]
		CASE 97
			[IF_DEBUG]
				CALL ナンプレ
				BREAK
			[ENDIF]
		CASE 98
			[IF_DEBUG]
				CALL ねらえ！ぴったり７, 100000
				BREAK
			[ENDIF]
		CASE 99
			RETURN 0
	ENDSELECT
LOOP 1

CALL CHECKDRAWLINE

;今回のギャンブルでの収支
収支 = MONEY-利益計算用

;ギャンブルでの総合収支
;G_MONEY += 収支

バンめし = 0
SELECTCASE カジノの種類
	;表カジノ 借金に上乗せ
	CASE 1
		PRINTFORML %CALLNAME:MASTER%はギャンブルを終えた。
		SELECTCASE 収支
			CASE IS > 0
				CALL PASELIL, @"{収支}＄儲かった！"
				;カードゲーム勝利数をプラス
				;SIF カードゲーム
				;	WIN_CARD++
			CASE IS < 0
				CALL PASELIL, @"{ABS(収支)}＄損してしまった……"
			CASE 0
				CALL PASELIL, "今回の収支はちょうど0＄のようだ。"
		ENDSELECT

		IF MONEY < 0
			CALL PASELIL, @"ギャンブル中に借金{ABS(MONEY)}＄を背負ったため、"
			CALL PASELIL, @"その{ABS(MONEY)}＄には利子{ABS(MONEY)*利子/100}＄が付き、借金は{ABS(MONEY)+ABS(MONEY)*利子/100}＄となります。"
			借金 += ABS(MONEY)+ABS(MONEY)*利子/100
			CALL PASELIL, @"借金の総額は{借金}＄となりました。"
			MONEY = 0
		ENDIF
		WAIT
	CASE 2
		PRINTW ………………
		PRINTW …………
		PRINTW ……
		$返済
		PRINTFORMW %CALLNAME:MASTER%はギャンブルに負け、借金を背負ってしまった
		PRINTW このカジノでは負けた場合、金銭以外のもので返済に当てなくてはならない
		PRINTL 返済の方法は……
		PRINTL [0] キャラを売り飛ばす
		PRINTL [1] 自らの身体で払う
		DO
			INPUT
			SELECTCASE RESULT
				CASE 0
					$売却キャラ選択
					CALL PASELIL, @"□誰を売り飛ばしますか？(返済額:{ABS(収支)}＄)"
					;売却可能でないキャラも売り飛ばせるが、総じて売値は半額になる アニマル、魔法効果発動中のキャラは売れない
					FOR PAGING, 0, CHARANUM
						LOCAL = 1
						SIF PAGING == MASTER
							LOCAL = 0
						SIF CFLAG:PAGING:憑依中
							LOCAL = 0
						SIF TALENT:PAGING:アニマル
							LOCAL = 0
						IF PAGING > 0
							CALL CHARA_SELL, PAGING
							IF RESULT
								キャラ価格 = RESULT/2
							ELSE
								キャラ価格 = 0
							ENDIF
						ENDIF
						CALL PAGING, LOCAL, @"価格:{キャラ価格} \@ 売却候補:PAGING ? 売却候補 #  \@"
					NEXT
					SELECTCASE RESULT
						CASE -1
							VARSET 売却候補
							GOTO 返済
						CASE 1 TO CHARANUM-1
							INVERTBIT 売却候補:RESULT, 0
					ENDSELECT
					売却総額 = 0
					FOR LCOUNT, 1, 1000
						IF 売却候補:LCOUNT
							CALL CHARA_SELL, LCOUNT
							SIF RESULT > 0
								売却総額 += RESULT/2
						ENDIF
						SIF 売却総額 >= ABS(MONEY)
							BREAK
					NEXT
					SIF 売却総額 < ABS(収支)
						GOTO 売却キャラ選択
					PRINTL □以下のキャラを裏カジノに対する返済として売り飛ばします。本当によろしいですか？
					FOR LCOUNT, 1, 1000
						SIF 売却候補:LCOUNT
							PRINTFORML 　%NAME:LCOUNT%
					NEXT
					DRAWLINE
					PRINTFORML 　総額:{売却総額}
					PRINTL 　[0] はい
					PRINTL 　[1] いいえ
					DO
						INPUT
						SELECTCASE RESULT
							CASE 0
								PRINTL 裏カジノに売り飛ばされた者たちは、別れを惜しむ間もなく黒ずくめの関係者に連れて行かれてしまった
								PRINTFORMW 皆がこれからどんな目に遭うのか、%CALLNAME:MASTER%には知る由もない……
								MONEY += 売却総額
								FOR LCOUNT, 1, 1000
									IF 売却候補:LCOUNT
										LOCAL = LCOUNT
										;アイドルユニットに属していた場合、そのユニットは解散
										SIF CFLAG:LOCAL:ユニット番号
											CALL BREAKUP, CFLAG:LOCAL:ユニット番号
										DELCHARA LOCAL
										LTARGET = TARGET
										LASSI = ASSI
										SIF LOCAL == LTARGET
											TARGET = -1
										SIF LOCAL == LASSI
											ASSI = -1
										SIF LOCAL < LTARGET
											TARGET--
										SIF LOCAL < LASSI
											ASSI--
									ENDIF
								NEXT
								RETURN 1
							CASE 1
								VARSET 売却候補
								GOTO 売却キャラ選択
						ENDSELECT
					LOOP 1
				CASE 1
					PRINTFORMW %CALLNAME:MASTER%はやむを得ず、自らの身体で借金を支払うことにした……
					PRINTW ………………
					PRINTW …………
					PRINTW ……
					;ペナルティは借金10万ごとに1日+3日
					;STRATEGYモードで裏カジノ負けた場合はバッドエンド直行
					IF FLAG:ゲームモード == 1
						CALL BADENDING_GAMBLE
					ELSE
						PRINTFORMW 調教する立場の%CALLNAME:MASTER%が散々に乱暴な調教を受け、解放されたときには{ABS(収支)/100000+3}日が経過していた……
						PRINTFORMW %CALLNAME:MASTER%は思い出しただけで吐き気を催す仕打ちに身を震わせながら、ぼろぼろの体を抱えてかろうじて屋敷に帰った……
						LOCAL = ABS(収支)/100000+3
						SELECTCASE SEX(MASTER)
							CASE 1
								PRINTFORML Ａ経験+{LOCAL/3}(%NAME:MASTER%)
								PRINTFORML 絶頂経験+{LOCAL/5}(%NAME:MASTER%)
								PRINTFORML 性交経験+{LOCAL/3}(%NAME:MASTER%)
								PRINTFORML 射精経験+{LOCAL/5}(%NAME:MASTER%)
								PRINTFORML 精液経験+{LOCAL}(%NAME:MASTER%)
								PRINTFORML ゲイ経験+{LOCAL}(%NAME:MASTER%)
								PRINTFORML フェラ経験+{LOCAL/5}(%NAME:MASTER%)
								PRINTFORML 緊縛経験+{LOCAL/7}(%NAME:PLAYER%)
								PRINTFORML Ａ拡張経験+{LOCAL/10}(%NAME:PLAYER%)
								EXP:MASTER:Ａ経験 += LOCAL/3
								EXP:MASTER:絶頂経験 += LOCAL/5
								EXP:MASTER:性交経験 += LOCAL/3
								EXP:MASTER:射精経験 += LOCAL/5
								EXP:MASTER:精液経験 += LOCAL
								EXP:MASTER:ゲイ経験 += LOCAL
								EXP:MASTER:フェラ経験 += LOCAL/5
								EXP:MASTER:緊縛経験 += LOCAL/7
								EXP:MASTER:Ａ拡張経験 += LOCAL/10
								WAIT
							CASE 2
								PRINTFORML Ｖ経験+{LOCAL/4}(%NAME:MASTER%)
								PRINTFORML Ａ経験+{LOCAL/6}(%NAME:MASTER%)
								PRINTFORML 絶頂経験+{LOCAL/5}(%NAME:MASTER%)
								PRINTFORML 性交経験+{LOCAL/3}(%NAME:MASTER%)
								PRINTFORML 膣射経験+{LOCAL/4}(%NAME:MASTER%)
								PRINTFORML 放尿経験+{LOCAL/10}(%NAME:MASTER%)
								PRINTFORML フェラ経験+{LOCAL/5}(%NAME:MASTER%)
								PRINTFORML 緊縛経験+{LOCAL/7}(%NAME:MASTER%)
								PRINTFORML Ｖ拡張経験+{LOCAL/10}(%NAME:MASTER%)
								PRINTFORML Ａ拡張経験+{LOCAL/10}(%NAME:MASTER%)
								PRINTFORML 流産経験+{LOCAL/100}(%NAME:MASTER%)
								EXP:MASTER:Ｖ経験 += LOCAL/4
								EXP:MASTER:Ａ経験 += LOCAL/6
								EXP:MASTER:絶頂経験 += LOCAL/5
								EXP:MASTER:性交経験 += LOCAL/3
								EXP:MASTER:膣射経験 += LOCAL/4
								EXP:MASTER:放尿経験 += LOCAL/10
								EXP:MASTER:フェラ経験 += LOCAL/5
								EXP:MASTER:緊縛経験 += LOCAL/7
								EXP:MASTER:Ｖ拡張経験 += LOCAL/10
								EXP:MASTER:Ａ拡張経験 += LOCAL/10
								EXP:MASTER:流産経験 += LOCAL/100
								WAIT
						ENDSELECT
						REPEAT ABS(収支)/100000+3
							CALL NEXTDAY
						REND
						MONEY += ABS(収支)
						RETURN 1
					ENDIF
			ENDSELECT
		LOOP 1
ENDSELECT

RETURN 1

;以下、各ゲーム共通の賭け金設定
@STAKE, 賭け金上限
#DIM DYNAMIC 利子
#DIM DYNAMIC 賭け金上限
#DIM DYNAMIC LCOUNT
#DIM DYNAMIC ループ用ステップ = 5
#DIM DYNAMIC マックスベット可

SIF 賭け金上限 <= 0
	RETURN 0

;ギャンブルで借金を背負った場合の利子(難易度によって変動)
SELECTCASE FLAG:難易度
	;NORMAL
	CASE 1
		利子 = 25
	;HYPER
	CASE 2
		利子 = 55
	;ANOTHER
	CASE 3
		利子 = 90
ENDSELECT

PRINTL いくら賭けますか？
PRINTL ただし、ギャンブル中に新たな借金を背負って返済できなかった場合、
CALL PASELIL, @"その借金に対し、{利子}\%の利子が付きます。"
PRINT (所持金:
SIF MONEY < 0
	SETCOLORBYNAME red
CALL PASELI, @"{MONEY}＄"
RESETCOLOR

CALL PASELIL, @" / MAXBET:{賭け金上限}＄)"

SETCOLORBYNAME skyblue
PRINT [1] $1  

FOR LCOUNT, 0, 賭け金上限+1, ループ用ステップ
	SELECTCASE LCOUNT
		CASE 5
			SETCOLORBYNAME crimson
		CASE 25
			SETCOLORBYNAME springgreen
		CASE 100
			SETCOLORBYNAME darkgray
		CASE 500
			SETCOLORBYNAME purple
		CASE 1000
			SETCOLORBYNAME gold
		CASE 5000
			SETCOLORBYNAME brown
		CASE 25000
			SETCOLORBYNAME orange
		CASEELSE
			マックスベット可 = 1
			CONTINUE
	ENDSELECT
	CALL PASELI, @"[{LCOUNT}] {LCOUNT}＄  "
	ループ用ステップ = LCOUNT
	マックスベット可 = 0
NEXT
PRINTL 
RESETCOLOR
SIF 賭け金上限 >= 100000
	CALL PASELI, @"[100000] 100000＄  "
SIF マックスベット可 && 賭け金上限 != 100000
	CALL PASELIL, @"[{賭け金上限}] MAXBET({賭け金上限}＄)"
$STAKE_INPUT
DO
	INPUT
	SELECTCASE RESULT
		CASE IS > 賭け金上限
			CALL PASELIL, @"賭け金上限は{賭け金上限}です。再入力してください"
		CASE IS > 0
			BREAK
	ENDSELECT
LOOP 1

RETURN RESULT

;フィッシャー・イェーツのシャッフル
;CARD:0からCARD:{ARG-1}までの配列にシャッフルした順列を返す
@SHUFFLE, ARG
#DIM DYNAMIC LCOUNT0
#DIM DYNAMIC LCOUNT1

FOR LCOUNT0, 0, ARG
	CARD:LCOUNT0 = LCOUNT0
NEXT

;LCOUNT0はARGの値から1づつ下げていく
FOR LCOUNT0, ARG, 0, -1
	LCOUNT1 = RAND:LCOUNT0;0以上LCOUNT0未満の数を決めてこれをLCOUNT1とする
	;LCOUNT1番目と(LCOUNT0-1)番目を入れ替える
	SWAP CARD:(LCOUNT0-1), CARD:LCOUNT1
NEXT

;第1引数を52で割った余りに対し以下を表示
;クラブK(余り0)→スペードA(余り1)→スペード2(余り2)→ … →ハートA(余り14)→ … →ダイヤA(余り27)→ … →クラブA(余り40)→ … →クラブQ(余り51)
;第2引数にSETCOLORBYNAMEで使える文字列を入れると強制的にその色になる
@PRTCARD, ARG, ARGS

IF ARGS == "" || COLOR_FROMNAME(ARGS) == -1
	SELECTCASE ((ARG+51)%52)/13
		;スペード
		CASE 0
			SETCOLORBYNAME deepskyblue
		;ハート
		CASE 1
			SETCOLORBYNAME hotpink
		;ダイヤ
		CASE 2
			SETCOLORBYNAME red
		;クラブ
		CASE 3
			SETCOLORBYNAME skyblue
	ENDSELECT
ELSE
	SETCOLOR COLOR_FROMNAME(ARGS)
ENDIF

SELECTCASE ((ARG+51)%52)/13
	;スペード
	CASE 0
		PRINT ♠
	;ハート
	CASE 1
		PRINT ♥
	;ダイヤ
	CASE 2
		PRINT ♦
	;クラブ
	CASE 3
		PRINT ♣
ENDSELECT

SELECTCASE ARG%13
	CASE 1
		PRINT Ａ
	;2～9はUIに配慮して全角にする
	CASE 2 TO 9
		PRINTFORM %TOFULL(TOSTR(ARG%13))%
	CASE 10
		PRINT 10
	CASE 11
		PRINT Ｊ
	CASE 12
		PRINT Ｑ
	CASEELSE
		PRINT Ｋ
ENDSELECT
RESETCOLOR

;上のボタン化関数 第二引数に押した時の返り値が入る
@PRTCARDBUTTON, ARG, ボタン, ARGS
#DIM DYNAMIC ボタン
#DIMS DYNAMIC スート
#DIMS DYNAMIC 数字

IF ARGS == "" || COLOR_FROMNAME(ARGS) == -1
	SELECTCASE ((ARG+51)%52)/13
		;スペード
		CASE 0
			SETCOLORBYNAME deepskyblue
		;ハート
		CASE 1
			SETCOLORBYNAME hotpink
		;ダイヤ
		CASE 2
			SETCOLORBYNAME red
		;クラブ
		CASE 3
			SETCOLORBYNAME skyblue
	ENDSELECT
ELSE
	SETCOLOR COLOR_FROMNAME(ARGS)
ENDIF

SELECTCASE ((ARG+51)%52)/13
	;スペード
	CASE 0
		スート = ♠
	;ハート
	CASE 1
		スート = ♥
	;ダイヤ
	CASE 2
		スート = ♦
	;クラブ
	CASE 3
		スート = ♣
ENDSELECT

SELECTCASE ARG%13
	CASE 1
		数字 = Ａ
	;2～9はUIに配慮して全角にする
	CASE 2 TO 9
		数字 = %TOFULL(TOSTR(ARG%13))%
	CASE 10
		数字 = 10
	CASE 11
		数字 = Ｊ
	CASE 12
		数字 = Ｑ
	CASEELSE
		数字 = Ｋ
ENDSELECT
PRINTBUTTON @"%スート%%数字%", ボタン
RESETCOLOR

