;---------------------------------------------------------
;射精するかのチェック
;---------------------------------------------------------
@SAMEN_CHECK_T, ARG
IF !PENIS(TARGET)
	BASE:射精 = 0
	RETURN 0
ENDIF 

;射精限界が来ている場合は射精しない 飾り値は+する
IF CFLAG:残数 == 0
	CFLAG:射精飾り値 += RAND:20+1
	BASE:射精 = CFLAG:射精飾り値
	RETURN 0
ENDIF

LOCAL = BASE:射精/MAXBASE:射精
SIF LOCAL <= 0
	RETURN 0

SELECTCASE ARG
	;奴隷→主人に中出し
	CASE 1
		IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 膣内大量射精（避妊具）
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 膣内射精（避妊具）
			ENDIF
		ELSE
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 膣内大量射精
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 膣内射精
			ENDIF
		ENDIF
	;奴隷→助手に中出し
	CASE 2
		IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 膣内大量射精（避妊具）
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 膣内射精（避妊具）
			ENDIF
		ELSE
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 膣内大量射精
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 膣内射精
			ENDIF
		ENDIF
	;フェラ
	CASE 3
		IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%口内大量射精（避妊具）
			ELSE
				PRINTFORML %CALLNAME:TARGET%口内射精（避妊具）
			ENDIF
		ELSE
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%口内大量射精
			ELSE
				PRINTFORML %CALLNAME:TARGET%口内射精
			ENDIF
		ENDIF
	;被挿入
	CASE 4
		IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%膣快楽大量射精（避妊具）
			ELSE
				PRINTFORML %CALLNAME:TARGET%膣快楽射精（避妊具）
			ENDIF
		ELSE
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%膣快楽大量射精
			ELSE
				PRINTFORML %CALLNAME:TARGET%膣快楽射精
			ENDIF
		ENDIF
	;被アナル挿入
	CASE 5
		SELECTCASE SEX(TARGET)
			;男
			CASE 1
				IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
					IF LOCAL >= 2
						PRINTFORML %CALLNAME:TARGET%前立腺大量射精（避妊具）
					ELSE
						PRINTFORML %CALLNAME:TARGET%前立腺射精（避妊具）
					ENDIF
				ELSE
					IF LOCAL >= 2
						PRINTFORML %CALLNAME:TARGET%前立腺大量射精
					ELSE
						PRINTFORML %CALLNAME:TARGET%前立腺射精
					ENDIF
				ENDIF
			;女
			CASE 2
				IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
					IF LOCAL >= 2
						PRINTFORML %CALLNAME:TARGET%アナル快楽大量射精（避妊具）
					ELSE
						PRINTFORML %CALLNAME:TARGET%アナル快楽射精（避妊具）
					ENDIF
				ELSE
					IF LOCAL >= 2
						PRINTFORML %CALLNAME:TARGET%アナル快楽大量射精
					ELSE
						PRINTFORML %CALLNAME:TARGET%アナル快楽射精
					ENDIF
				ENDIF
		ENDSELECT
	;奴隷→主人にアナル中出し
	CASE 6
		IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 腸内大量射精（避妊具）
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 腸内射精（避妊具）
			ENDIF
		ELSE
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 腸内大量射精
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:MASTER% 腸内射精
			ENDIF
		ENDIF
	;奴隷→助手にアナル中出し
	CASE 7
		IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 腸内大量射精（避妊具）
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 腸内射精（避妊具）
			ENDIF
		ELSE
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 腸内大量射精
			ELSE
				PRINTFORML %CALLNAME:TARGET%→%CALLNAME:ASSI% 腸内射精
			ENDIF
		ENDIF
	;その他
	CASEELSE
		IF TEQUIP:コンドーム && TEQUIP:搾精コンドーム
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%大量射精（避妊具）
			ELSE
				PRINTFORML %CALLNAME:TARGET%射精（避妊具）
			ENDIF
		ELSE
			IF LOCAL >= 2
				PRINTFORML %CALLNAME:TARGET%大量射精
			ELSE
				PRINTFORML %CALLNAME:TARGET%射精
			ENDIF
		ENDIF
ENDSELECT

NOWEX:射精 = LOCAL

;射精強度を表示
SIF LOCAL >= 3
	PRINTFORML 射精強度×{LOCAL}

RETURN BASE:射精 / MAXBASE:射精

;実績:性転換、もしくはふたなり化しためうとまり花をオナホで射精させる
IF TEQUIP:オナホール && !TEQUIP:コンドーム && !TEQUIP:搾精コンドーム
	SELECTCASE CHARANAMEF(TARGET)
		CASE "芽兎 めう"
			SETBIT オナホパフェ, 0
		CASE "山形 まり花"
			SETBIT オナホパフェ, 1
	ENDSELECT
	SIF GETBIT(オナホパフェ, 0) && GETBIT(オナホパフェ, 1)
		CALL 実績解除, "オナホパフェだよ☆ONP"
ENDIF

@SAMEN_SHOOT_T, ARG, ARG:1, ARG:2 = -1
#DIM 射精量
;ARG:0 = 射精先
;ARG:1 = 射精量
;ARG:2 = 射精されるキャラ
SIF ARG:2 == -1
	ARG:2 = PLAYER
SIF ARG:1 <= 0
	RETURN 0

射精量 = ARG:1

;ARG:0内訳
;1 = 主人の膣内に射精
;2 = 助手の膣内に射精
;3 = フェラ
;4 = 被挿入
;5 = 被アナル挿入
;6 = 主人の腸内に射精
;7 = 助手の腸内に射精
;0 = その他

SELECTCASE ARG
	;奴隷→主人に中出し
	CASE 1
		IF !TEQUIP:コンドーム && !TEQUIP:搾精コンドーム
			SETBIT TFLAG:中出し, 4
			PRINTFORML 膣内射精経験+{ARG:1}（%CALLNAME:MASTER%）
			EXP:MASTER:膣射経験 += ARG:1
			PREG:4 += 射精量
			中出し人数:(NO:MASTER)++
			中出され人数:MASTER:(NO:TARGET)++
			CFLAG:主人への膣射経験++
			;獣人、獣による催淫
			SELECTCASE CSTR:種族
				CASE "獣人", "獣"
					CFLAG:MASTER:残数 += ((CFLAG:MASTER:媚薬%5)+射精量)/5
					CFLAG:MASTER:媚薬 += 射精量
			ENDSELECT
		ENDIF
	;奴隷→助手に中出し
	CASE 2
		IF !TEQUIP:コンドーム && !TEQUIP:搾精コンドーム
			SETBIT TFLAG:中出し, 2
			PRINTFORML 膣内射精経験+{ARG:1}（%CALLNAME:ASSI%）
			EXP:ASSI:膣射経験 += ARG:1
			PREG:ASSI:2 += ARG:1
			中出し人数:(NO:ASSI)++
			中出され人数:ASSI:(NO:TARGET)++
			CFLAG:助手への膣射経験++
			;獣人、獣による催淫
			SELECTCASE CSTR:種族
				CASE "獣人", "獣"
					CFLAG:ASSI:残数 += ((CFLAG:ASSI:媚薬%5)+射精量)/5
					CFLAG:ASSI:媚薬 += 射精量
			ENDSELECT
		ENDIF
	;フェラ
	CASE 3
		SIF PLAYER == MASTER
			CFLAG:口で射精した経験++
		IF !TEQUIP:コンドーム && !TEQUIP:搾精コンドーム
			IF PLAYER == MASTER
				SETBIT TFLAG:口内射精, 2
			ELSEIF PLAYER == ASSI
				SETBIT TFLAG:口内射精, 1
			ENDIF
			;獣人、獣による催淫
			SELECTCASE CSTR:種族
				CASE "獣人", "獣"
					CFLAG:PLAYER:残数 += ((CFLAG:PLAYER:媚薬%5)+射精量)/5
					CFLAG:PLAYER:媚薬 += 射精量
			ENDSELECT
		ENDIF
	;被挿入
	CASE 4
		SIF PLAYER == MASTER
			CFLAG:膣を責められて射精した経験++
	;被アナル挿入
	CASE 5
		SIF PLAYER == MASTER
			CFLAG:アナルを責められて射精した経験++
	;奴隷→主人にアナル中出し
	CASE 6
		IF !TEQUIP:コンドーム && !TEQUIP:搾精コンドーム
			SETBIT TFLAG:中出し, 5
			CFLAG:主人への腸射経験++
			;獣人、獣による催淫
			SELECTCASE CSTR:種族
				CASE "獣人", "獣"
					CFLAG:MASTER:残数 += ((CFLAG:MASTER:媚薬%5)+射精量)/5
					CFLAG:MASTER:媚薬 += 射精量
			ENDSELECT
		ENDIF
	;奴隷→助手にアナル中出し
	CASE 7
		IF !TEQUIP:コンドーム && !TEQUIP:搾精コンドーム
			SETBIT TFLAG:中出し, 3
			CFLAG:助手への腸射経験++
			;獣人、獣による催淫
			SELECTCASE CSTR:種族
				CASE "獣人", "獣"
					CFLAG:ASSI:残数 += ((CFLAG:ASSI::媚薬%5)+射精量)/5
					CFLAG:ASSI:媚薬 += 射精量
			ENDSELECT
		ENDIF
	;その他
	CASEELSE
		;
ENDSELECT

SELECTCASE SELECTCOMS
	CASE "キスする"
		CFLAG:キスで射精した経験++
	CASE "兜合わせ"
		SIF NOWEX:MASTER:射精
			CFLAG:兜合わせで一緒に射精した経験++
	CASE "正常位", "後背位", "騎乗位", "背面座位", "対面座位"
		SIF PLAYER == MASTER
			CFLAG:犯されて射精した経験++
	CASE "正常位アナル", "後背位アナル", "騎乗位アナル", "背面座位アナル", "対面座位アナル"
		SIF PLAYER == MASTER
			CFLAG:アナルを犯されて射精した経験++
ENDSELECT
SIF TEQUIP:ビデオカメラ
	CFLAG:射精を撮影された経験++
IF TEQUIP:オナホール
	IF TEQUIP:触手
		CFLAG:触手射精経験++
	ELSE
		CFLAG:オナホで射精した経験++
	ENDIF
ENDIF
SIF SEX(TARGET) == 1 && (TEQUIP:アナルバイブ || TEQUIP:アナルビーズ || TEQUIP:アナル電極 || TEQUIP:浣腸器 || TEQUIP:Ａ異物)
	CFLAG:道具で前立腺射精経験++
SIF TEQUIP:コンドーム
	CFLAG:避妊具射精経験++
SIF TEQUIP:搾精コンドーム
	CFLAG:搾精経験++
SIF TEQUIP:野外プレイ
	CFLAG:野外で射精した経験++

;経験増加
IF EXP:射精経験 == 0 && SEX(TARGET) == 2
	PRINTFORMW %CALLNAME:TARGET%は女性には知り得ない射精の快感を味わってしまった(異常経験+1)
	EXP:異常経験++
ENDIF

PRINTFORML 精液経験+{ARG:1}（%CALLNAME:(ARG:2)%）
EXP:(ARG:2):精液経験 += ARG:1

PRINTFORML 射精経験+{ARG:1}
EXP:射精経験 += ARG:1

;精液汚れの設定
SETBIT STAIN:ペニス, 2

;射精カウント
NOWEX:射精 = ARG:1
EX:射精++

BASE:射精 -= MAXBASE:射精*ARG:1
SIF BASE:射精 >= MAXBASE:射精
	BASE:射精 = MAXBASE:射精-1

LOSEBASE:体力 += 20*ARG:1
LOSEBASE:気力 += 30*ARG:1

;ビデオ撮影時はボーナスカウント
SIF TEQUIP:ビデオカメラ
	VIDEOBONUS:4++

;ソース追加
;射精経験多いほど恥ずかしくなくなって気持ち良くなる
IF EXP:射精経験 > EXPLV:5
	SOURCE:露出 += (150 * ABL:欲望)
	SOURCE:屈従 += (2500 * ABL:欲望)
	SOURCE:不潔 += (100 * ABL:欲望)
ELSEIF EXP:射精経験 > EXPLV:4
	SOURCE:露出 += (500 * ABL:欲望)
	SOURCE:屈従 += (1500 * ABL:欲望)
	SOURCE:不潔 += (150 * ABL:欲望)
ELSEIF EXP:射精経験 > EXPLV:3
	SOURCE:露出 += (700 * ABL:欲望)
	SOURCE:屈従 += (700 * ABL:欲望)
	SOURCE:不潔 += (200 * ABL:欲望)
ELSEIF EXP:射精経験 > EXPLV:2
	SOURCE:露出 += (1500 * ABL:欲望)
	SOURCE:屈従 += (400 * ABL:欲望)
	SOURCE:不潔 += (250 * ABL:欲望)
ELSEIF EXP:射精経験 > EXPLV:1
	SOURCE:露出 += (2500 * ABL:欲望)
	SOURCE:屈従 += (250 * ABL:欲望)
	SOURCE:不潔 += (300 * ABL:欲望)
ELSE
	SOURCE:露出 += (5000 * ABL:欲望)
	SOURCE:屈従 += (150 * ABL:欲望)
	SOURCE:不潔 += (400 * ABL:欲望)
ENDIF

SOURCE:中毒 += 500*ARG:1
SOURCE:液体 += 100*ARG:1

;射精後は再装填の時間を設ける
SELECTCASE ARG:1
	CASE 1
		CFLAG:賢者タイム = 3
	CASE IS >= 2
		CFLAG:賢者タイム = ARG:1+3
ENDSELECT
CFLAG:残数 -= 1

IF TEQUIP:コンドーム || TEQUIP:搾精コンドーム
	SIF TEQUIP:コンドーム
		TFLAG:使用済み避妊具 = 3
	SIF TEQUIP:搾精コンドーム
		TFLAG:搾精量 += ARG:1
	TEQUIP:コンドーム = 0
	SIF !TEQUIP:触手
		TEQUIP:搾精コンドーム = 0
	SETBIT TFLAG:避妊具射精, 2
	;コンドーム自動装着処理
	IF GETBIT(FLAG:避妊具設定, 2)
		IF ITEM:コンドーム > 0
			ITEM:コンドーム--
			TEQUIP:コンドーム = 1
		ENDIF
		IF ITEM:コンドーム == 0
			PRINTL <コンドームが無くなったので、自動装着を解除します>
			CLEARBIT FLAG:避妊具設定, 2
		ENDIF
	ELSEIF GETBIT(FLAG:避妊具設定, 3) && !TEQUIP:触手
		IF ITEM:搾精コンドーム > 0
			ITEM:搾精コンドーム--
			TEQUIP:搾精コンドーム = 1
		ENDIF
		IF ITEM:搾精コンドーム == 0
			PRINTL <搾精コンドームが無くなったので、自動装着を解除します>
			CLEARBIT FLAG:避妊具設定, 3
		ENDIF
	ENDIF
ENDIF

;天使による感度アップ
SIF CSTR:種族 == "天使"
	TFLAG:天使の感度ボーナス++


;-------------------------------------------------
;調教対象の噴乳チェック
;-------------------------------------------------
@TARGET_MILK_CHECK
SIF !TALENT:母乳体質
	RETURN 0

LOCAL = UP:快Ｃ/5 + UP:快Ｖ/5 + UP:快Ａ/5 + UP:快Ｂ*3

;自制心
SIF TALENT:自制心
	LOCAL /= 2

;快感に素直
SIF TALENT:快感に素直
	TIMES LOCAL , 1.20

;快感の否定（淫乱、娼婦で無効）
SIF TALENT:快感の否定 && (!TALENT:淫乱 && !TALENT:娼婦)
	TIMES LOCAL , 0.80

;B敏感
SIF TALENT:Ｂ敏感
	TIMES LOCAL , 1.20

;媚薬
SIF CFLAG:媚薬
	LOCAL += LOCAL/10*CFLAG:媚薬

;調教者が幼児退行
SIF TALENT:PLAYER:幼児／幼児退行
	TIMES LOCAL , 1.20

;調教者が幼稚
SIF TALENT:PLAYER:幼稚
	TIMES LOCAL , 1.20

SELECTCASE TALENT:バストサイズ
	;爆乳
	CASE 5
		TIMES LOCAL , 1.40
	;巨乳
	CASE 4
		TIMES LOCAL , 1.20
	;普通
	CASE 3
		TIMES LOCAL , 1.00
	;貧乳
	CASE 2
		TIMES LOCAL , 0.80
	;絶壁
	CASE 1
		TIMES LOCAL , 0.60
ENDSELECT

;噴乳中毒のレベルを見る
SELECTCASE ABL:噴乳中毒
	CASE 0
		TIMES LOCAL , 1.00
	CASE 1
		TIMES LOCAL , 1.05
	CASE 2
		TIMES LOCAL , 1.10
	CASE 3
		TIMES LOCAL , 1.20
	CASE 4
		TIMES LOCAL , 1.30
	CASE IS >= 5
		LOCAL += (LOCAL/10) * (ABL:噴乳中毒/2+1)
ENDSELECT

LOCAL = 500 + LOCAL/2
BASE:母乳 += LOCAL

LOCAL = BASE:母乳/MAXBASE:母乳

;噴乳
IF LOCAL
	LOSEBASE:体力 += 10*LOCAL
	LOSEBASE:気力 += 50*LOCAL
	IF EXP:噴乳経験 > EXPLV:5
		SOURCE:露出 += (5000 * LOCAL)
		SOURCE:屈従 += (2500 * LOCAL)
		SOURCE:不潔 += (300 * LOCAL)
	ELSEIF EXP:噴乳経験 > EXPLV:4
		SOURCE:露出 += (2500 * LOCAL)
		SOURCE:屈従 += (1500 * LOCAL)
		SOURCE:不潔 += (250 * LOCAL)
	ELSEIF EXP:噴乳経験 > EXPLV:3
		SOURCE:露出 += (1500 * LOCAL)
		SOURCE:屈従 += (700 * LOCAL)
		SOURCE:不潔 += (200 * LOCAL)
	ELSEIF EXP:噴乳経験 > EXPLV:2
		SOURCE:露出 += (700 * LOCAL)
		SOURCE:屈従 += (400 * LOCAL)
		SOURCE:不潔 += (150 * LOCAL)
	ELSEIF EXP:噴乳経験 > EXPLV:1
		SOURCE:露出 += (500 * LOCAL)
		SOURCE:屈従 += (300 * LOCAL)
		SOURCE:不潔 += (100 * LOCAL)
	ELSE
		SOURCE:露出 += (300 * LOCAL)
		SOURCE:屈従 += (150 * LOCAL)
	ENDIF

	IF LOCAL >= 2
		PRINTFORML %CALLNAME:TARGET%大量噴乳
	ELSE
		PRINTFORML %CALLNAME:TARGET%噴乳
	ENDIF
;	PRINTFORML 噴乳経験+{LOCAL}
	IF !EXP:噴乳経験
		EXP:異常経験++
		PRINTL 異常経験+1
	ENDIF
	EXP:噴乳経験 += LOCAL
	;Ｂに母乳汚れ
	SETBIT STAIN:胸, 4

	NOWEX:噴乳 = LOCAL
	EX:噴乳++

	BASE:母乳 -= MAXBASE:母乳*LOCAL
	SIF BASE:母乳 >= MAXBASE:母乳
		BASE:母乳 = MAXBASE:母乳-1

	;ビデオ撮影中はボーナスカウント
	IF TEQUIP:ビデオカメラ
		VIDEOBONUS:6++
		CFLAG:噴乳を撮影された経験++
	ENDIF

	;搾乳器で母乳が集められているかチェック
	IF TEQUIP:搾乳器
		TFLAG:搾乳量 += LOCAL
		CFLAG:搾乳された経験++
	ELSE
		;獣人、獣による催淫
		SELECTCASE CSTR:種族
			CASE "獣人", "獣"
				CFLAG:PLAYER:残数 += ((CFLAG:PLAYER:媚薬%5)+LOCAL)/5
				CFLAG:PLAYER:媚薬 += LOCAL
		ENDSELECT
	ENDIF
	
	LOCAL = 0
	;飲んでる場合
	IF PLAYER == MASTER
		SELECTCASE SELECTCOMS
			CASE "母乳飲み", "授乳手コキ"
				;不要なループを避けるための処理 CFLAGでやったほうがいいかもしれない
				SIF 母乳飲んだ人数:(NO:TARGET)
					LOCAL = 1
				母乳飲んだ人数:(NO:TARGET)++
		ENDSELECT
	ENDIF
	IF LOCAL
		LOCAL = 0
		REPEAT 10000
			SIF 母乳飲んだ人数:COUNT
				LOCAL++
		REND
		SIF LOCAL >= 10
			CALL 実績解除, "母乳ソムリエ"
	ENDIF
ENDIF

