read me from QhrTea目次
0. ライセンス
1. 概要
2. 全般の注意点
3. 各システムの解説
	3.1. 気温
	3.2. 曜日
	3.3. 降水量


◆◆◆ 0. ライセンス ◆◆◆
eraBEMANIに導入されているQhrTeaが担当したシステム部分はeraBEMANIのライセンスに準拠します
質問や意見などがありましたら、私のTwitterアカウント(@3qua75)にお願いします


◆◆◆ 1. 概要 ◆◆◆
細かい追加要素をいくつか担当しましたQhrTeaです
これらの機能の軽い解説と他のバリアントに移植や改変する際の注意点を記述していきます
以降敬体から常体へ


◆◆◆ 2. 全般の注意点 ◆◆◆
◇eraBEMANI独自の変数・式中関数について◇
「3. 各システムの解説」内でそれぞれ記述はするが、うっかり導入するとエラーの原因になる
また、eraBEMANIには便利な式中関数「LOOPRES」が使われていて、それがコード内に書かれている可能性がある

◇数値を扱うときの注意◇
Emuera(というか多くのプログラム)において、剰余演算(モジュロ演算)は少し異なる挙動を起こす
【例】
	A = (-13)%10
	PRINTFORM {A}
この結果は「-3」を表示する
数学において -13 ≡ 7 ≡ -3 (mod 10)であるのだが、0～9が表示されることを期待すると思わぬエラーを起こす
また、小数がその都度切り捨てられることを注意しないと負の数の床関数(ガウス記号)で痛い目にあう
【例】
	A = -624
	B = A / 100
	PRINTFORM {B}
この結果は「-6」となり、Bへの代入を床関数のように扱うのならば「間違い」となる
[]を床関数とすると、[(-624)/100] = -7が正しい
対策としては、Aの中身をチェックしてマイナスかつ切り捨てが発生する前の値が整数でないのなら
結果を-1する(もしくはそのような式中関数を作る)のが簡単だろう


◆◆◆ 3. 各システムの解説 ◆◆◆
◆ 3.1. 気温 ◆
「気温.ERB」全部と「日付変更時及びキャラ専用イベント.ERB」のキャラごとの気温補正部分を担当

《使用している独自変数》
<関数内のみで使用しているもの>
	AVERAGE
	夜補正
<それ以外>
	MONTH
	DAYS (経過日数を表すDAYとは異なる)
	変動値
	FLAG:気温

「@TEMPERATURE」は変数「FLAG:気温」に気温の10倍の値(19.3℃なら193)を代入する関数である
次の式で気温を算出する
	FLAG:気温 = AVERAGE + 変動値 - 夜補正
AVERAGEとは現在の日付の東京の平均気温を指し、MONTHとDAYSから366通り毎回決まった値が代入される
気象庁のデータを参考にしており、1月21日～1月30日に最低の4.9℃、8月4日～8月9日に最高の26.7℃となる
物語の舞台が東京付近の気候でないのなら、適宜補正を加えるか新しくテーブルを組むべきだろう
変動値とは、@TEMPERATUREが1回呼び出されるごとに計算される1次元ランダムウォークな変数であり、
	0 → -13 → 15 → 39 → 49 → 20 → 21
といった感じで毎回-30～+30のうちランダムな値だけ変動する
ただし、-50以下・50以上にはならない(例えば計算した値が57なら、49へ変更される)
「変動値」を使うことで気温の高い日の次の日も気温が高いままでありやすい
夜補正とは、TIMEが1(eraBEMANIでは夜を表す)のときだけランダムに計算される値である
季節によってランダム幅が異なり、例えば11月と12月と1月は0～39の間の値をとり、
最後に「FLAG:気温」の値をその分だけ減らす

さらにeraBEMANIでは、ターン毎に現在いるキャラによって補正をかけている
主人・奴隷・助手の場合効果が強くなる

・参考資料
気象庁　東京 1月 平年値 (日ごとの値) 詳細(気温)
http://www.data.jma.go.jp/obd/stats/etrn/view/nml_sfc_d.php?prec_no=44&block_no=47662&year=&month=1&day=1&view=a2

◆ 3.2. 曜日 ◆
「曜日,及び暦関連の式中関数.ERB」の@ZELLERと@GREGORIANと@DOWとそれに付随した日付周りのシステムを担当

《使用している独自変数》
<関数内のみで使用しているもの>
	年
	月
	日
※eraBEMANIでは曜日を管理する変数(FLAG:曜日)は使っていますがこの関数の外で代入しています

▲日付に関する基礎知識
まず、BC1年を「0年」、BC2年を「-1年」といったように連続した数値で管理するものとする
後述するツェラーの公式もこの扱いが前提となっている
現在使われている暦は「グレゴリオ暦」というものだが、この暦においてうるう年は次のように定められている
	4の倍数をうるう年とする
	100の倍数をうるう年から除く
	ただし400の倍数はうるう年とする
このルールが適用されるグレゴリオ暦は1582年10月15日(金)からである
それより前には「ユリウス暦」という暦が使われていたが、この暦ではうるう年は次のように定められている
	4の倍数をうるう年とする
ただし、BC45年からBC8年にかけてうるう年が間違った使われ方をしていた
さらにそのしわ寄せとしてBC5年とBC1年と4年が本来うるう年が存在するはずなのにうるう年が置かれなかった
うるう年があった年を並べると次のようになる(BC45年(=-44年)にうるう年が置かれてない点に注意!)
BC44年、BC41年、BC38年、BC35年、BC32年、BC29年、BC26年、BC23年、BC20年、BC17年、BC14年、BC11年、BC8年、8年、12年…
それぞれを「連続した値」で表すと、
-43, -40, -37, -34, -31, -28, -25, -22, -19, -16, -13, -10, -7, 8, 12…
となる
これらのユリウス暦が運用されたのはBC45年1月1日(金)から1582年10月4日(木)までである
なお、1582年10月5日から1582年10月14日の10日間は存在せず、eraBEMANIにおいても日付は飛ばされる
なおeraBEMANIにおいては、BC46年以前についての暦は詳しい資料が存在しないうえに、日付のカウントも曖昧なので
便宜的にすべてユリウス暦で扱っている

@ZELLERは「ツェラーの公式」を用いて曜日に対応した数値を算出する関数
数学的な妥当性の証明は他のWebページを参照してほしい
なお、負の数の剰余や床関数は扱いに注意すること
@GREGORIANではグレゴリオ暦かどうかを判定しているが、グレゴリオ暦でない時期をすべてユリウス暦とみなしている
さらに、先述した「間違った運用のユリウス暦」の補正も盛り込んでいる
以上をすべて計算すると次のような結果が出る
	1:日, 2:月, 3:火, 4:水, 5:木, 6:金, 0:土
なお、IOS 8601(日付と時刻の表記に関する国際規格)においては
	7:日, 1:月, 2:火, 3:水, 4:木, 5:金, 6:土
となっているのでツェラーの公式で求めた値をh、IOS 8601における値をDとすると、
	D = (h + 5)%7 + 1
で変換できる
@DOWでは
	1:日, 2:月, 3:火, 4:水, 5:木, 6:金, 0:土
を基準として数値を文字列に変換する

他のバリアントで@ZELLERなどを使う場合はグレゴリオ暦かどうかの判定に気をつけなければならない
例えば@ZELLERの内部で年を+2000する処理を加えれば、
「1年1月1日」は「2001年1月1日」として計算されるので、グレゴリオ暦として扱える
なお、2001年1月1日は月曜日であるのだが、先程の+2000をする変換を利用する際に
「1年1月1日」を日曜日としたい場合は、ツェラーの公式で求めた値をh、欲しい値をXとすると、
	X = (h + 6)%7
で変換できる(他の曜日でも同様)
なお、変換する際は負の数に対する剰余が発生しないように注意する(例えば上記の変換式のカッコの中身をh-1としてはいけない)

◆ 3.3. 降水量 ◆
「降水量.ERB」全部と「天気.ERB」の雨かどうかを判定する部分を担当

《使用している独自変数》
<関数内のみで使用しているもの>
	F1
	F10
	P_A
	P_B
	R_MM (0～50の配列になっている)
<それ以外>
	MONTH
	DAYS (経過日数を表すDAYとは異なる)
	FLAG:降水量

@PRECIPITATIONとは、降水量を(日付ごとに決められた分布で)ランダムに与える関数である
降水量の基準は気象庁のデータを使っている(関数「@TOKYO_STYLE_RAINY_DAY」より取得する)
そのデータを参考に、降水量Xミリ以上になる確率(パーセント)を算出する関数F(X)をパラメータA,Bを用いて、
	F(X) = 100    (X=0)
	F(X) = AX + B (X>0)
とおく
F(1)の値をF1、F(10)の値をF10、パラメータA,Bの値を1000倍したものをP_A,P_Bとする
実際に7月1日の確率分布を計算してみよう
@TOKYO_STYLE_RAINY_DAYより7月1日の降水量が、
1mm以上になる確率は43%、10mm以上になる確率は19%であるというデータが取得できる
つまり、F(1)=F1=43、F(10)=F10=19となる
	 43 =   A + B
	 19 = 10A + B
を満たすようなA,Bを求める
	-24 = 9A
	  A = -2.666666…
P_Aには、この1000倍の-2666が代入される
P_Bも1000倍の値が欲しいので
	  B = 43 - A
	P_B = 43000 - P_A
	P_B = 45666
したがって、7月1日において降水量Xミリ以上になる確率Yは
	Y = -2.666X + 45.666 (パーセント)
で求められることがわかった
この結果から求められる確率分布をR_MMの配列に全て代入する
すなわち、
	R_MM:X = -2.666X + 45.666
	       = (-2666X + 45666) / 1000
これより、
	(R_MM:0 = 100) ※代入はされていないが便宜的にこう置いた
	R_MM:1  = 43
	R_MM:2  = 40
	R_MM:3  = 37
	R_MM:4  = 35
	R_MM:5  = 32
		(省略)
	R_MM:9  = 21
	R_MM:10 = 19
		(省略)
	R_MM:16 = 3
	R_MM:17 = 0
	R_MM:18 = -2
		(省略)
となり、分布ができたので1～100の値をランダムに出して、
100～44なら0mm、43～41なら1mm、40～38なら2mm、37～36なら3mm…といった具合に降水量を決める
このとき、1mm以上になる確率が43%、10mm以上になる確率が19%となっている
また、1～100の値に対しR_MM:17=0であることから、この計算の段階では
7月1日の分布においては17mm以上の降水量は絶対に起きないようになっている
(ただしeraBEMANIにおいては天気の概念があり、それによって降水量が増える)

この値をFLAG:降水量に代入する
また、eraBEMANIにおいては基本的に雨量が1mm以上の場合に雨や雪となる
例えば7月1日の場合、晴れか曇りになる確率は57%である

・参考資料
気象庁　東京 1月 平年値 (日ごとの値) 詳細(降水量・日照)
http://www.data.jma.go.jp/obd/stats/etrn/view/nml_sfc_d.php?prec_no=44&block_no=47662&year=&month=01&day=1&view=a1

・余談
関数「@TOKYO_STYLE_RAINY_DAY」はm1dyの曲「TOKTO STYLE SPEEDCORE」から
IIDXではジャンル名となっている
