
Emuera1824+v9+WebP_fixtest0001
by 東etoマン


１．　これは何？
Emuera1824+v9+WebPはWebP形式の画像が使えるのでリソースのファイルサイズを小さくできる、けどeraTWで起動時にリソース関連でエラーが出たり出なかったりする現象が確認されています。
色々調べてみたところ、WebP対応のために使用しているライブラリの中に間違いと思われる箇所を発見しました。
そこだけ修正してみました。修正したソースファイル1個と、exeファイルを入れてます。


２．　注意事項
既存バリアントのEmueraをEmuera1824+v9+WebP_fixtest0001に差し替えて遊ぶ場合、既存のフォルダを丸ごとコピーして、片方のフォルダのEmueraだけをEmuera1824+v9+WebP_fixtest0001に差し替えてください。そして、Emuera差し替え済みフォルダのセーブデータなどはEmuera差し替え前フォルダに持ち込まないようにしてください。
Emueraのバージョンに関係無いであろうと思われる不具合がEmuera1824+v9+WebP_fixtest0001上で遊んでいて発生した場合は、Emuera差し替え前フォルダの環境だけ使用しても発生することを確認してからバリアント作者に不具合報告するのが理想です。発生頻度などの問題でそれが難しい場合は、差し替えたEmueraのバージョンを明記してバリアント作者に不具合報告してください。
Emuera自体が原因だろうけどEmuera1824+v9+WebP_fixtest0001固有ではないと思われる不具合がEmuera1824+v9+WebP_fixtest0001上で遊んでいて発生した場合は、Emuera差し替え前フォルダの環境だけ使用しても発生することを確認してからEmueraスレに不具合報告してください。Emuera1824+v9+WebPじゃないバージョンで不具合発生しない場合はEmuera1824+v9+WebPも試しましょう。
Emuera1824+v9+WebP_fixtest0001固有の不具合は修正するかどうか不明です。


３．　Emuera1824+v9+WebP から変更した箇所
"Emuera\_Library\WebPWrapper.cs"
DLLからの戻り値がintになってるのをIntPtrに変更した。該当箇所では、64bitアプリとして実行する場合はintではなくIntPtrが正しいはず。32bitアプリとして実行する場合はどちらでも影響ないはずだけど。


４．　今後の改善や変更案
今回の修正方法で正しければ、の話だけど
・Emuera1824+v9+WebP以外とのマージ
・GCREATEFROMFILE命令もWebPに対応させる
・その他、細かい改善
気が向いたらやる。自分がやるかどうかは不明。
誰かがやってくれたら嬉しい。


５．　ビルド方法
Visual Studio Community 2017でビルド可能なはず。
Emuera1824+v9+WebPのソースを展開して "Emuera\_Library\WebPWrapper.cs" だけ差し替えたらソースの準備は完了。
IDEを起動しなくても "開発者コマンド プロンプト for VS2017" でEmuera.slnのあるフォルダに移動して
devenv.com Emuera.sln /Rebuild "Release|Any CPU"
でビルドできるみたいなので、少し文字や数値を変更する程度だったらみんな軽率にビルドすればいいと思うよ。それを配布するかどうかはまた別の話だけど。
VS2013やVS2015やVS2019は未確認です。


６．　ライセンス
元のライブラリは MIT License って書いてあるので、変更した WebPWrapper.cs も真似して MIT License ってことにしておきます。

